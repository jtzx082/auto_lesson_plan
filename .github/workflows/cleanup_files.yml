name: Cleanup Old Lesson Plans (Files)

on:
  # 1. æ¯å‘¨ä¸€å‡Œæ™¨ 4:00 (åŒ—äº¬æ—¶é—´) è‡ªåŠ¨è¿è¡Œ
  schedule:
    - cron: '0 20 * * 1'
  
  # 2. æ‰‹åŠ¨è§¦å‘ (æ”¯æŒè‡ªå®šä¹‰ä¿ç•™å¤©æ•°)
  workflow_dispatch:
    inputs:
      retention_days:
        description: 'ä¿ç•™æœ€è¿‘å¤šå°‘å¤©çš„æ•™æ¡ˆï¼Ÿ(è¾“å…¥ 0 ä»£è¡¨åˆ é™¤æ‰€æœ‰æ–‡ä»¶)'
        required: true
        default: '30'
        type: string

permissions:
  contents: write

jobs:
  cleanup_files:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Execute Cleanup Script
        env:
          # å¦‚æœæ˜¯å®šæ—¶è¿è¡Œï¼Œé»˜è®¤ä¿ç•™ 60 å¤©ï¼›å¦‚æœæ˜¯æ‰‹åŠ¨è¿è¡Œï¼Œä½¿ç”¨è¾“å…¥å€¼
          RETENTION_DAYS: ${{ inputs.retention_days || '60' }}
        run: |
          python -c "
          import os
          import glob
          from datetime import datetime, timedelta

          # è·å–é…ç½®
          try:
              days = int(os.environ['RETENTION_DAYS'])
          except:
              days = 60
              
          cutoff_date = datetime.now() - timedelta(days=days)
          target_dir = 'generated_plans'
          
          print(f'ğŸ§¹ æ¸…ç†ä»»åŠ¡å¼€å§‹ï¼šæ­£åœ¨å¯»æ‰¾ {days} å¤©å‰ (å³ {cutoff_date.strftime('%Y-%m-%d')} ä¹‹å‰) çš„æ–‡ä»¶...')
          
          deleted_count = 0

          if not os.path.exists(target_dir):
              print('ğŸ“‚ ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡ã€‚')
              exit(0)

          # éå† Markdown æ–‡ä»¶
          for filepath in glob.glob(f'{target_dir}/*.md'):
              filename = os.path.basename(filepath)
              
              # æ–‡ä»¶åæ ¼å¼é€šå¸¸ä¸º: 20260121_Manual_xxx.md
              # æˆ‘ä»¬å°è¯•æå–å‰8ä½ä½œä¸ºæ—¥æœŸ
              try:
                  date_part = filename.split('_')[0]
                  # ç®€å•çš„æ ¡éªŒï¼šå¿…é¡»æ˜¯8ä½æ•°å­—
                  if len(date_part) != 8 or not date_part.isdigit():
                      continue
                      
                  file_date = datetime.strptime(date_part, '%Y%m%d')
                  
                  # æ ¸å¿ƒåˆ¤æ–­ï¼šå¦‚æœæ–‡ä»¶æ—¥æœŸ æ—©äº æˆªæ­¢æ—¥æœŸï¼Œåˆ™åˆ é™¤
                  if file_date < cutoff_date:
                      os.remove(filepath)
                      print(f'ğŸ—‘ï¸ å·²åˆ é™¤è¿‡æœŸæ–‡ä»¶: {filename}')
                      deleted_count += 1
              except Exception as e:
                  # å¦‚æœæ–‡ä»¶åæ ¼å¼ä¸å¯¹ï¼Œè·³è¿‡ä¸åˆ ï¼Œé˜²æ­¢è¯¯åˆ é‡è¦æ–‡ä»¶
                  continue

          print(f'âœ… æ¸…ç†å®Œæˆã€‚å…±åˆ é™¤äº† {deleted_count} ä¸ªæ–‡ä»¶ã€‚')
          "

      - name: Commit and Push Changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«åˆ é™¤ï¼ˆgit status ä¼šæ˜¾ç¤º changesï¼‰
          if [[ -n $(git status -s) ]]; then
            git config --global user.name "Cleaner Bot"
            git config --global user.email "action@github.com"
            git add generated_plans/
            git commit -m "Cleanup: Remove old lesson plans [skip ci]"
            git push
            echo "ğŸš€ ä¿®æ”¹å·²æ¨é€åˆ°ä»“åº“ã€‚"
          else
            echo "âœ¨ æ²¡æœ‰æ–‡ä»¶éœ€è¦æ¸…ç†ã€‚"
          fi
